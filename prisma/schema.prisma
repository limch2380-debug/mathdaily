// ============================================
// 수학 학습지 앱 - PostgreSQL Prisma Schema
// ============================================

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// 사용자 테이블
// ─────────────────────────────────────────────
model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  grade     Int      @default(1)         // 학년 (난이도 기반)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  worksheets   DailyWorksheet[]
  responses    UserResponse[]
  weaknessLogs WeaknessLog[]
}

// ─────────────────────────────────────────────
// 일일 학습지 (DailyWorksheet)
// ─────────────────────────────────────────────
// 매일 사용자에게 제공되는 문제 세트
model DailyWorksheet {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @db.Date              // 학습 날짜 (YYYY-MM-DD)
  title       String                          // "2026-02-14 학습지"
  totalCount  Int      @default(10)           // 총 문제 수
  isCompleted Boolean  @default(false)        // 완료 여부 (출석 도장)
  score       Float?                          // 점수 (완료 후 계산)
  difficulty  String   @default("medium")     // easy | medium | hard
  topics      String[]                        // 다루는 단원 태그들
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  problems  Problem[]
  responses UserResponse[]

  @@unique([userId, date])                   // 사용자당 하루 1개 학습지
  @@index([userId, date])
}

// ─────────────────────────────────────────────
// 문제 (Problem)
// ─────────────────────────────────────────────
model Problem {
  id           String   @id @default(cuid())
  worksheetId  String
  orderNum     Int                            // 문제 번호 (1, 2, 3...)
  question     String                         // 문제 텍스트
  answer       String                         // 정답
  options      String[]                       // 보기 (객관식일 경우)
  type         String   @default("short")     // short(단답) | multiple(객관식) | essay(서술)
  topic        String                         // 단원 (예: 분수, 방정식)
  difficulty   String   @default("medium")    // easy | medium | hard
  explanation  String?                        // 풀이 설명
  createdAt    DateTime @default(now())

  worksheet DailyWorksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  responses UserResponse[]

  @@unique([worksheetId, orderNum])
}

// ─────────────────────────────────────────────
// 사용자 답안 (UserResponse)
// ─────────────────────────────────────────────
model UserResponse {
  id            String   @id @default(cuid())
  userId        String
  worksheetId   String
  problemId     String
  userAnswer    String                          // 사용자가 입력한 답
  isCorrect     Boolean                         // 정답 여부
  timeSpentSec  Int?                            // 풀이 소요 시간 (초)
  submittedAt   DateTime @default(now())

  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  worksheet   DailyWorksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  problem     Problem        @relation(fields: [problemId], references: [id], onDelete: Cascade)
  weaknessLog WeaknessLog?                      // 틀린 경우 취약점 분석 연결

  @@unique([userId, problemId])                 // 사용자당 문제당 1개 답안
  @@index([userId, worksheetId])
}

// ─────────────────────────────────────────────
// 취약점 분석 결과 (WeaknessLog)
// ─────────────────────────────────────────────
// 틀린 문제의 원인을 태깅하고 집중 케어에 활용
model WeaknessLog {
  id             String   @id @default(cuid())
  userId         String
  responseId     String   @unique             // 1:1 관계 (UserResponse)
  
  // ── 틀린 원인 태깅 ──
  // CALCULATION_ERROR: 계산 실수 (부호 실수, 연산 오류)
  // CONCEPT_GAP:       개념 부족 (공식/정의 미숙지)
  // MISREAD:           문제 잘못 읽음 (조건 누락, 단위 혼동)
  // TIME_PRESSURE:     시간 부족으로 인한 오류
  // CARELESS:          부주의 (답 옮겨 적기 실수 등)
  // FORMULA_ERROR:     공식 적용 오류
  // PROCESS_ERROR:     풀이 과정 오류
  // OTHER:             기타
  errorType      String                       // 위 enum 값 중 하나
  
  topic          String                       // 관련 단원
  subtopic       String?                      // 세부 단원
  severity       Int      @default(1)         // 심각도 (1: 경미 ~ 5: 심각)
  description    String?                      // 상세 설명
  isResolved     Boolean  @default(false)     // 해결 여부
  resolvedAt     DateTime?                    // 해결 시점
  repeatCount    Int      @default(1)         // 같은 유형 반복 횟수
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  response UserResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([userId, errorType])
  @@index([userId, topic])
  @@index([userId, isResolved])
}
